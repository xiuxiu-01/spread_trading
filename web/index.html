<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arbitrage Monitor</title>
    <script src="lightweight-charts.js"></script>
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --border: #30363d;
            --green: #238636;
            --red: #da3633;
        }
        
        * { box-sizing: border-box; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        header h1 { 
            margin: 0; 
            font-size: 1.2rem; 
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-link {
            color: var(--accent);
            text-decoration: none;
            font-size: 0.85rem;
            padding: 5px 10px;
            border: 1px solid var(--accent);
            border-radius: 4px;
            transition: all 0.2s;
        }

        .admin-link:hover {
            background: var(--accent);
            color: white;
        }

        .status {
            font-size: 0.85rem;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(218, 54, 51, 0.2);
        }
        .status.connected { 
            color: var(--green); 
            background: rgba(35, 134, 54, 0.2);
        }
        .status.disconnected { color: var(--red); }

        .main-content {
            padding: 10px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 8px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9rem;
        }
        .tab-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Panels */
        .panel {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .panel h3 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Account Info */
        .account-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .account-card {
            padding: 10px;
            background: #1a1a2e;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .account-card strong {
            display: block;
            margin-bottom: 5px;
        }

        /* Real-time Quotes */
        .quotes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .quote-card {
            padding: 10px;
            background: #1a1a2e;
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        
        .quote-card strong {
            display: block;
            margin-bottom: 8px;
        }
        
        .quote-row {
            display: flex;
            justify-content: space-between;
        }
        
        .quote-value {
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .quote-label {
            font-size: 0.75em;
            color: var(--text-secondary);
        }

        /* Charts */
        .chart-container {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .chart-title {
            margin: 0 0 5px 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .chart-div {
            height: 250px;
            width: 100%;
        }
        
        .chart-legend {
            position: absolute;
            top: 35px;
            left: 15px;
            z-index: 10;
            font-size: 11px;
            font-family: monospace;
            pointer-events: none;
        }

        /* Controls */
        .control-group {
            margin-bottom: 12px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .control-group input[type="number"],
        .control-group input[type="text"] {
            width: 100%;
            background: var(--bg-color);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .control-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        button {
            background-color: var(--green);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            width: 100%;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-red { background-color: var(--red); }
        .btn-blue { background-color: var(--accent); }
        
        .btn-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .btn-row button {
            flex: 1;
        }

        /* Order History */
        .order-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .order-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .order-direction {
            font-weight: bold;
        }
        
        .order-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .order-details {
            color: var(--text-secondary);
        }
        
        .order-error {
            color: var(--red);
            font-size: 0.75rem;
            margin-top: 4px;
        }

        /* PnL Summary */
        .pnl-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px;
            background: #1a1a2e;
            border-radius: 6px;
            border: 1px solid var(--border);
        }
        
        .pnl-item {
            text-align: center;
        }
        
        .pnl-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .pnl-value {
            font-size: 1.1rem;
            font-weight: bold;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        
        .pnl-value.total {
            font-size: 1.3rem;
        }
        
        .pnl-positive { color: var(--green); }
        .pnl-negative { color: var(--red); }
        .pnl-zero { color: var(--text-secondary); }
        
        /* Order Logs List */
        .order-logs-list {
            max-height: 500px;
            overflow-y: auto;
            background: #0d1117;
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        
        .order-log-item {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }
        
        .order-log-item:last-child {
            border-bottom: none;
        }
        
        .order-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .order-log-dir {
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .order-log-dir.long {
            background: rgba(35, 134, 54, 0.3);
            color: var(--green);
        }
        
        .order-log-dir.short {
            background: rgba(218, 54, 51, 0.3);
            color: var(--red);
        }
        
        .order-log-prices {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px 15px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border);
        }
        
        .order-log-pnl {
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        /* Trigger Description */
        .trigger-desc {
            margin: 8px 0 4px 0;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .trigger-desc.auto {
            background: rgba(88, 166, 255, 0.15);
            border-left: 3px solid var(--accent);
            color: var(--accent);
        }
        
        .trigger-desc.manual {
            background: rgba(210, 153, 34, 0.15);
            border-left: 3px solid #d29922;
            color: #d29922;
        }

        /* Logs */
        .log-container {
            background: #0d1117;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
        }
        
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
        }
        
        .log-time {
            color: var(--text-secondary);
            margin-right: 8px;
        }
        
        .log-info { color: var(--accent); }
        .log-success { color: var(--green); }
        .log-error { color: var(--red); }
        .log-warn { color: #d29922; }

        /* Auto Trade Status Display */
        .auto-trade-status {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.95rem;
        }
        
        .auto-trade-status.on {
            background: rgba(35, 134, 54, 0.3);
            border: 2px solid var(--green);
            color: var(--green);
        }
        
        .auto-trade-status.off {
            background: rgba(218, 54, 51, 0.3);
            border: 2px solid var(--red);
            color: var(--red);
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 1.5s infinite;
        }
        
        .auto-trade-status.on .status-dot {
            background: var(--green);
            box-shadow: 0 0 8px var(--green);
        }
        
        .auto-trade-status.off .status-dot {
            background: var(--red);
            box-shadow: 0 0 8px var(--red);
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        /* Toggle Switch */
        .auto-trade-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            margin-bottom: 12px;
            background: #1a1a2e;
            border-radius: 6px;
            border: 1px solid var(--border);
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            margin-right: 12px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--red);
            transition: 0.3s;
            border-radius: 30px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--green);
            box-shadow: 0 0 10px var(--green);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        
        .toggle-label {
            font-size: 1rem;
            font-weight: bold;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1rem;
            }
            
            .main-content {
                padding: 8px;
            }
            
            .tabs {
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-btn {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            .account-grid {
                grid-template-columns: 1fr;
            }
            
            .quotes-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .chart-div {
                height: 200px;
            }
            
            .panel {
                padding: 10px;
            }
            
            .quote-value {
                font-size: 1em;
            }
            
            .btn-row {
                flex-direction: column;
            }
            
            .order-list {
                max-height: 200px;
            }
            
            .log-container {
                height: 300px;
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .quotes-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-div {
                height: 180px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <h1>Arbitrage Monitor</h1>
            <div style="margin-left: 15px;">
                <select id="taskSelector" style="background:#1f2428; border:1px solid #30363d; color:#c9d1d9; padding:4px 8px; border-radius:4px; font-size: 0.9rem;">
                    <option value="mt5-okx-xau" selected>Gold (XAU)</option>
                    <option value="mt5-okx-xag">Silver (XAG)</option>
                </select>
            </div>
            <a href="admin.html" class="admin-link">üìä Admin Dashboard</a>
        </div>
        <div id="connectionStatus" class="status disconnected">Êú™ËøûÊé•</div>
    </header>

    <div class="main-content">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="dashboard">‰ª™Ë°®Áõò</button>
            <button class="tab-btn" data-tab="charts">ÂõæË°®</button>
            <button class="tab-btn" data-tab="trading">‰∫§Êòì</button>
            <button class="tab-btn" data-tab="orders">ËÆ¢Âçï</button>
            <button class="tab-btn" data-tab="logs">Êó•Âøó</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content active">
            <!-- Account Info -->
            <div class="panel">
                <h3>Ë¥¶Êà∑‰ø°ÊÅØ</h3>
                <div class="account-grid">
                    <div class="account-card">
                        <strong style="color: #4caf50;">MT5</strong>
                        ÂáÄÂÄº: <span id="mt5-equity">--</span><br/>
                        <span>Net Lots:</span> <span id="mt5-net" style="font-weight: bold;">0.00</span>
                    </div>
                    <div class="account-card">
                        <strong style="color: #ff9800;">OKX</strong>
                        USDT‰ΩôÈ¢ù: <span id="okx-balance">--</span><br/>
                        <span>Eq Lots:</span> <span id="okx-net" style="font-weight: bold;">0.00</span>
                    </div>
                    <div class="account-card">
                        <strong style="color: #58a6ff;">Á≠ñÁï•‰ªì‰Ωç</strong>
                        <div style="font-size: 1.5rem; font-weight: bold; margin-top: 5px;">
                            <span id="strategy-position" style="color: var(--text-secondary);">Flat</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Quotes -->
            <div class="panel">
                <h3>ÂÆûÊó∂Ë°åÊÉÖ (Real-time Quotes)</h3>
                <div class="quotes-grid">
                    <div class="quote-card">
                        <strong style="color: #4caf50;">MT5</strong>
                        <div class="quote-row">
                            <div>
                                <div class="quote-label">‰π∞‰ª∑</div>
                                <div class="quote-value" id="rt-mt5-bid" style="color: #ef5350;">--</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="quote-label">Âçñ‰ª∑</div>
                                <div class="quote-value" id="rt-mt5-ask" style="color: #4caf50;">--</div>
                            </div>
                        </div>
                    </div>
                    <div class="quote-card">
                        <strong style="color: #ff9800;">OKX</strong>
                        <div class="quote-row">
                            <div>
                                <div class="quote-label">‰π∞‰ª∑</div>
                                <div class="quote-value" id="rt-okx-bid" style="color: #ef5350;">--</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="quote-label">Âçñ‰ª∑</div>
                                <div class="quote-value" id="rt-okx-ask" style="color: #4caf50;">--</div>
                            </div>
                        </div>
                    </div>
                    <div class="quote-card">
                        <strong style="color: #58a6ff;">Spread (ÂÆûÊó∂ / 5sÂùáÂÄº)</strong>
                        <div class="quote-row">
                            <div>
                                <div class="quote-label">ÂÅöÁ©∫ Sell</div>
                                <div class="quote-value" id="rt-spread-sell">--</div>
                                <div class="quote-value" id="rt-avg-spread-sell" style="font-size: 0.8rem; color: #888;">--</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="quote-label">EMA</div>
                                <div class="quote-value" id="rt-ema" style="color: #fff;">--</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="quote-label">ÂÅöÂ§ö Buy</div>
                                <div class="quote-value" id="rt-spread-buy">--</div>
                                <div class="quote-value" id="rt-avg-spread-buy" style="font-size: 0.8rem; color: #888;">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Trade Buttons -->
            <div class="panel">
                <h3>Âø´Êç∑‰∫§Êòì</h3>
                <div id="autoTradeStatus" class="auto-trade-status off">
                    <span class="status-dot"></span>
                    <span class="status-text">Ëá™Âä®‰∫§Êòì: Â∑≤ÂÖ≥Èó≠</span>
                </div>
                <div class="btn-row">
                    <button id="btnLongQuick" style="background-color: var(--green);">ÂÅöÂ§ö‰ª∑Â∑Æ</button>
                    <button id="btnShortQuick" style="background-color: var(--red);">ÂÅöÁ©∫‰ª∑Â∑Æ</button>
                </div>
                <button id="closeAllQuick" class="btn-red">ÂÖ®ÈÉ®Âπ≥‰ªì</button>
            </div>
        </div>

        <!-- Charts Tab -->
        <div id="tab-charts" class="tab-content">
            <div class="chart-container">
                <h3 class="chart-title">KÁ∫øÂõæ (MT5 vs OKX)</h3>
                <div id="priceChart" class="chart-div"></div>
                <div id="priceLegend" class="chart-legend">
                    <div style="color: #4caf50">MT5 <span id="mt5Val"></span></div>
                    <div style="color: #ef5350">OKX <span id="okxVal"></span></div>
                </div>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">ÂÅöÁ©∫Spread (ÂçñMT5‰π∞OKX)</h3>
                <div id="spreadSellChart" class="chart-div"></div>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">ÂÅöÂ§öSpread (‰π∞MT5ÂçñOKX)</h3>
                <div id="spreadBuyChart" class="chart-div"></div>
            </div>
            <button id="scrollToLatest" class="btn-blue" style="margin-top: 10px;">Ë∑≥Âà∞ÊúÄÊñ∞</button>
        </div>

        <!-- Trading Tab -->
        <div id="tab-trading" class="tab-content">
            <div class="panel">
                <h3>ÂèÇÊï∞ËÆæÁΩÆ</h3>
                <div id="paramsForm"></div>
                <button id="updateBtn">Êõ¥Êñ∞ÂèÇÊï∞</button>
            </div>

            <div class="panel">
                <h3>ÊâãÂä®‰∫§Êòì</h3>
                <div class="control-group">
                    <label>ÊâãÊï∞ (Lots)</label>
                    <input type="number" id="tradeVol" value="0.01" step="0.01">
                </div>
                <div class="btn-row">
                    <button id="btnLong" style="background-color: var(--green);">ÂÅöÂ§ö‰ª∑Â∑Æ</button>
                    <button id="btnShort" style="background-color: var(--red);">ÂÅöÁ©∫‰ª∑Â∑Æ</button>
                </div>
                <div class="auto-trade-toggle">
                    <label class="toggle-switch">
                        <input type="checkbox" id="chkAutoTrade">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label">ÂêØÁî®Ëá™Âä®‰∫§Êòì</span>
                </div>
                <button id="closeAllBtn" class="btn-red">ÂÖ®ÈÉ®Âπ≥‰ªì</button>
            </div>

            <div class="panel">
                <h3>‰∫§ÊòìÂìÅÁßç</h3>
                <p style="margin: 5px 0; font-size: 0.85rem;">OKX: <span id="okxSymbol">-</span></p>
                <p style="margin: 5px 0; font-size: 0.85rem;">MT5: <span id="mt5Symbol">-</span></p>
            </div>
        </div>

        <!-- Orders Tab -->
        <div id="tab-orders" class="tab-content">
            <!-- Order Logs Panel -->
            <div class="panel">
                <h3>ËÆ¢ÂçïÊó•Âøó (Ëøë50Êù°)</h3>
                <div class="btn-row" style="margin-bottom: 10px;">
                    <button id="refreshOrderLogs" class="btn-blue">Âà∑Êñ∞ËÆ¢ÂçïÊó•Âøó</button>
                </div>
                <!-- PnL Summary -->
                <div id="pnlSummary" class="pnl-summary">
                    <div class="pnl-item">
                        <span class="pnl-label">MT5 Áõà‰∫è:</span>
                        <span id="pnlMt5" class="pnl-value">--</span>
                    </div>
                    <div class="pnl-item">
                        <span class="pnl-label">OKX Áõà‰∫è:</span>
                        <span id="pnlOkx" class="pnl-value">--</span>
                    </div>
                    <div class="pnl-item">
                        <span class="pnl-label">ÊÄªÁõà‰∫è:</span>
                        <span id="pnlTotal" class="pnl-value total">--</span>
                    </div>
                    <div class="pnl-item">
                        <span class="pnl-label">ËÆ¢ÂçïÊï∞:</span>
                        <span id="orderCount" class="pnl-value">--</span>
                    </div>
                </div>
                <!-- Order Logs List -->
                <div id="orderLogsList" class="order-logs-list"></div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="tab-logs" class="tab-content">
            <div class="panel">
                <h3>Á≥ªÁªüÊó•Âøó</h3>
                <div class="btn-row" style="margin-bottom: 10px;">
                    <button id="clearLogs" class="btn-blue">Ê∏ÖÁ©∫Êó•Âøó</button>
                </div>
                <div id="logContainer" class="log-container"></div>
            </div>
        </div>
    </div>

    <script>
        // Logging system
        const logs = [];
        const MAX_LOGS = 500;
        
        function addLog(message, level = 'info') {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            logs.unshift({ time: timeStr, message, level });
            if (logs.length > MAX_LOGS) logs.pop();
            renderLogs();
        }
        
        function renderLogs() {
            const container = document.getElementById('logContainer');
            if (!container) return;
            container.innerHTML = logs.map(log => `
                <div class="log-entry">
                    <span class="log-time">${log.time}</span>
                    <span class="log-${log.level}">${log.message}</span>
                </div>
            `).join('');
        }
        
        document.getElementById('clearLogs')?.addEventListener('click', () => {
            logs.length = 0;
            renderLogs();
        });

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
                
                // Resize charts when switching to charts tab
                if (btn.dataset.tab === 'charts') {
                    setTimeout(() => {
                        priceChart.timeScale().fitContent();
                        spreadSellChart.timeScale().fitContent();
                        spreadBuyChart.timeScale().fitContent();
                    }, 100);
                }
                
                // Auto refresh order logs when switching to orders tab
                if (btn.dataset.tab === 'orders') {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'get_order_logs', limit: 50 }));
                    }
                }
            });
        });

        // Account rendering
        function renderAccount(accountState) {
            try {
                // Debug log
                // addLog(`Account Debug: ${JSON.stringify(accountState)}`, 'info'); 
                
                if (!accountState) return;

                const mt5Bal = accountState.balance?.mt5 || 0;
                const mt5Net = accountState.net?.mt5 || 0;
                const okxBal = accountState.balance?.okx || 0;
                const okxNet = accountState.net?.okx || 0;
                
                const elMt5Eq = document.getElementById('mt5-equity');
                const elMt5Net = document.getElementById('mt5-net');
                const elOkxBal = document.getElementById('okx-balance');
                const elOkxNet = document.getElementById('okx-net');

                if (elMt5Eq) elMt5Eq.textContent = mt5Bal.toFixed(2);
                if (elMt5Net) {
                    elMt5Net.textContent = mt5Net.toFixed(2);
                    elMt5Net.style.color = mt5Net > 0 ? 'var(--green)' : (mt5Net < 0 ? 'var(--red)' : '#d29922');
                }
                
                if (elOkxBal) elOkxBal.textContent = okxBal.toFixed(4);
                if (elOkxNet) {
                    elOkxNet.textContent = okxNet.toFixed(2);
                    elOkxNet.style.color = okxNet > 0 ? 'var(--green)' : (okxNet < 0 ? 'var(--red)' : '#d29922');
                }
                
                // Update strategy position
                const positionEl = document.getElementById('strategy-position');
                if (positionEl && accountState.position) {
                    const pos = accountState.position;
                    if (pos.level > 0 && pos.direction) {
                        const dirLabel = pos.direction === 'long' ? 'Long' : 'Short';
                        positionEl.textContent = `L${pos.level} ${dirLabel}`;
                        positionEl.style.color = pos.direction === 'long' ? 'var(--green)' : 'var(--red)';
                    } else {
                        positionEl.textContent = 'Flat';
                        positionEl.style.color = 'var(--text-secondary)';
                    }
                }
            } catch (e) {
                console.error("Render Account Error", e);
                addLog(`Render Account Error: ${e.message}`, 'error');
            }
        }

        // Charts setup
        const { createChart, ColorType, CrosshairMode, LineStyle } = LightweightCharts;

        const chartOptions = {
            layout: {
                textColor: '#c9d1d9',
                background: { type: ColorType.Solid, color: '#161b22' },
            },
            timezone: 'Etc/UTC',
            grid: {
                vertLines: { visible: false },
                horzLines: { visible: false },
            },
            crosshair: {
                mode: CrosshairMode.Normal,
            },
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
                borderColor: '#30363d',
            },
            rightPriceScale: {
                borderColor: '#30363d',
            },
        };

        // Price Chart
        const priceContainer = document.getElementById('priceChart');
        const priceChart = createChart(priceContainer, chartOptions);
        
        const mt5Series = priceChart.addSeries(LightweightCharts.CandlestickSeries, {
            upColor: '#238636', 
            downColor: '#da3633', 
            borderUpColor: '#238636',
            borderDownColor: '#da3633',
            wickUpColor: '#238636',
            wickDownColor: '#da3633',
            title: 'MT5',
        });
        
        const okxSeries = priceChart.addSeries(LightweightCharts.CandlestickSeries, {
            upColor: '#4caf50',
            downColor: '#ef5350',
            borderUpColor: '#4caf50',
            borderDownColor: '#ef5350',
            wickUpColor: '#4caf50',
            wickDownColor: '#ef5350',
            title: 'OKX',
        });
        
        // Spread Sell Chart
        const spreadSellContainer = document.getElementById('spreadSellChart');
        const spreadSellChart = createChart(spreadSellContainer, chartOptions);
        
        const spreadSellSeries = spreadSellChart.addSeries(LightweightCharts.LineSeries, {
            color: '#ef5350',
            lineWidth: 2,
            title: 'ÂÅöÁ©∫‰ª∑Â∑Æ',
        });
        
        // Spread Buy Chart
        const spreadBuyContainer = document.getElementById('spreadBuyChart');
        const spreadBuyChart = createChart(spreadBuyContainer, chartOptions);
        
        const spreadBuySeries = spreadBuyChart.addSeries(LightweightCharts.LineSeries, {
            color: '#4caf50',
            lineWidth: 2,
            title: 'ÂÅöÂ§ö‰ª∑Â∑Æ',
        });

        // EMA Series for both charts
        const emaSellSeries = spreadSellChart.addSeries(LightweightCharts.LineSeries, {
            color: '#ffffff',
            lineWidth: 1,
            title: 'EMA',
            lastValueVisible: false,
            priceLineVisible: false,
        });
        
        const emaBuySeries = spreadBuyChart.addSeries(LightweightCharts.LineSeries, {
            color: '#ffffff',
            lineWidth: 1,
            title: 'EMA',
            lastValueVisible: false,
            priceLineVisible: false,
        });
        
        // L1-Ln threshold series (will be created dynamically based on maxPos)
        const sellThresholdSeries = [];
        const buyThresholdSeries = [];
        const thresholdColors = ['#ff6b6b', '#ff9f43', '#feca57', '#48dbfb', '#a29bfe'];
        
        // Create threshold series for max 5 levels
        for (let i = 0; i < 5; i++) {
            sellThresholdSeries.push(spreadSellChart.addSeries(LightweightCharts.LineSeries, {
                color: thresholdColors[i],
                lineWidth: 1,
                title: `L${i + 1}`,
                lastValueVisible: false,
                priceLineVisible: false,
            }));
            buyThresholdSeries.push(spreadBuyChart.addSeries(LightweightCharts.LineSeries, {
                color: thresholdColors[i],
                lineWidth: 1,
                title: `L${i + 1}`,
                lastValueVisible: false,
                priceLineVisible: false,
            }));
        }

        // Chart resize observers
        new ResizeObserver(() => {
            const rect = priceContainer.getBoundingClientRect();
            priceChart.applyOptions({ width: rect.width, height: rect.height });
        }).observe(priceContainer);

        new ResizeObserver(() => {
            const rect = spreadSellContainer.getBoundingClientRect();
            spreadSellChart.applyOptions({ width: rect.width, height: rect.height });
        }).observe(spreadSellContainer);
        
        new ResizeObserver(() => {
            const rect = spreadBuyContainer.getBoundingClientRect();
            spreadBuyChart.applyOptions({ width: rect.width, height: rect.height });
        }).observe(spreadBuyContainer);
        
        // Sync charts
        const charts = [priceChart, spreadSellChart, spreadBuyChart];
        
        function syncCharts(sourceChart) {
            const range = sourceChart.timeScale().getVisibleLogicalRange();
            if (!range) return;
            charts.forEach(c => {
                if (c !== sourceChart) {
                    c.timeScale().setVisibleLogicalRange(range);
                }
            });
        }
        
        charts.forEach(c => {
            c.timeScale().subscribeVisibleLogicalRangeChange(() => syncCharts(c));
        });

        // Scroll to latest button
        document.getElementById('scrollToLatest')?.addEventListener('click', () => {
            priceChart.timeScale().scrollToPosition(0, true);
        });

        // WebSocket
        let ws;
        let reconnectTimer;
        const statusEl = document.getElementById('connectionStatus');
        
        function connect() {
            const qs = new URLSearchParams(window.location.search);
            const wsOverride = qs.get('ws');
            const wsHostOverride = qs.get('wsHost');

            const isFile = window.location.protocol === 'file:';
            const isHttps = window.location.protocol === 'https:';
            const scheme = isHttps ? 'wss' : 'ws';
            
            // Backend defaults to port 8766
            const defaultPort = '8766';
            const hostname = isFile ? 'localhost' : window.location.hostname;

            const host = wsHostOverride
                ? wsHostOverride
                : `${hostname}:${defaultPort}`;

            const url = wsOverride || `${scheme}://${host}/ws`;
            
            addLog(`Ê≠£Âú®ËøûÊé• ${url}...`, 'info');
            statusEl.textContent = 'ËøûÊé•‰∏≠...';
            statusEl.className = 'status disconnected';

            try {
                ws = new WebSocket(url);
            } catch (e) {
                addLog(`ËøûÊé•ÈîôËØØ: ${e}`, 'error');
                scheduleReconnect();
                return;
            }
            
            ws.onopen = () => {
                statusEl.textContent = 'Â∑≤ËøûÊé•';
                statusEl.className = 'status connected';
                addLog('WebSocket Â∑≤ËøûÊé•', 'success');
                
                // Send initial requests
                ws.send(JSON.stringify({ type: "get_history", task_id: currentTask }));
                ws.send(JSON.stringify({ type: "get_account", payload: { task_id: currentTask } }));
                ws.send(JSON.stringify({ type: "get_params", payload: { task_id: currentTask } }));
                ws.send(JSON.stringify({ type: "get_order_logs", limit: 50 }));

                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }
            };
            
            ws.onclose = () => {
                statusEl.textContent = 'Â∑≤Êñ≠ÂºÄ';
                statusEl.className = 'status disconnected';
                addLog('WebSocket Â∑≤Êñ≠ÂºÄÔºåÊ≠£Âú®ÈáçËøû...', 'warn');
                scheduleReconnect();
            };

            ws.onerror = (err) => {
                addLog('WebSocket ÈîôËØØ', 'error');
                try { ws.close(); } catch (_) {}
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    handleMessage(msg);
                } catch (e) {
                    addLog(`Ëß£ÊûêÈîôËØØ: ${e}`, 'error');
                }
            };
        }

        function scheduleReconnect() {
            if (reconnectTimer) return;
            reconnectTimer = setTimeout(() => {
                reconnectTimer = null;
                connect();
            }, 3000);
        }

        const paramsForm = document.getElementById('paramsForm');
        let currentParams = {};
        
        // Task Management
        let currentTask = 'mt5-okx-xau';
        const taskSelector = document.getElementById('taskSelector');
        
        taskSelector.addEventListener('change', (e) => {
            currentTask = e.target.value;
            addLog(`ÂàáÊç¢‰ªªÂä°Ëá≥: ${currentTask}`, 'info');
            
            // Clear charts
            if (mt5Series) mt5Series.setData([]);
            if (okxSeries) okxSeries.setData([]);
            if (spreadSellSeries) spreadSellSeries.setData([]);
            if (spreadBuySeries) spreadBuySeries.setData([]);
            if (emaSellSeries) emaSellSeries.setData([]);
            if (emaBuySeries) emaBuySeries.setData([]);
            
            // Reset state
            globalSpreadData = [];
            globalEmaData = [];
            
            // Refresh
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "get_history", task_id: currentTask }));
            }
        });

        let markers = [];
        let globalSpreadData = [];
        let globalEmaData = [];
        let globalOrderHistory = [];
        let latestHistoryMsg = null;
        
        // Store EMA history data for threshold calculation
        let emaHistoryData = [];

        function handleMessage(msg) {
            // Task Filtering
            // Allow messages with no task_id (global) or matching task_id
            if (msg.task_id && msg.task_id !== currentTask) {
                return; 
            }

            if (msg.type === 'params') {
                updateParamsUI(msg.payload);
            } else if (msg.type === 'account') {
                // addLog('Received account update', 'info');
                renderAccount(msg.payload);
            } else if (msg.type === 'bar') {
                updateCharts(msg.payload);
                renderOrderMarkers();
                addLog(`Êñ∞KÁ∫ø: ‰ª∑Â∑Æ=${msg.payload.spread?.toFixed(2)}`, 'info');
            } else if (msg.type === 'history') {
                latestHistoryMsg = msg.payload;
                loadHistory(msg.payload);
                addLog(`ÂéÜÂè≤Êï∞ÊçÆÂ∑≤Âä†ËΩΩ: ${msg.payload.mt5?.length || 0} Ê†πKÁ∫ø`, 'success');
            } else if (msg.type === 'orders') {
                globalOrderHistory = msg.payload;
                updateOrderList(msg.payload);
                renderOrderMarkers();
            } else if (msg.type === 'tick') {
                updateRealtimeQuotes(msg.payload);
            } else if (msg.type === 'trade_result') {
                handleTradeResult(msg.payload);
            } else if (msg.type === 'order_logs') {
                renderOrderLogs(msg.payload);
            }
        }
        
        // EMA Freeze Logic
        let lastEmaUpdateTime = 0;
        let fixedEmaValue = 0;

        // Update threshold series with new data point (for real-time updates)
        function updateThresholdSeries(tick) {
            const ema = tick.ema;
            const time = tick.time;
            if (ema === null || ema === undefined || !time) return;
            
            const OFFSET_SECONDS = 8 * 3600;
            // Spread updates in real-time (tick time)
            
            // EMA and Thresholds snap to the minute start (bar_time)
            // This prevents the lines from extending into the forming minute
            const barTime = tick.bar_time ? (tick.bar_time + OFFSET_SECONDS) : (time + OFFSET_SECONDS);
            
            // Logic: EMA update only happens at the start of 1m
            if (barTime !== lastEmaUpdateTime) {
                lastEmaUpdateTime = barTime;
                fixedEmaValue = ema;
            }
            // Otherwise use fixedEmaValue (no intra-candle updates for EMA lines)
            
            const firstSpread = currentParams.firstSpread || 3.0;
            const nextSpread = currentParams.nextSpread || 1.0;
            const maxPos = currentParams.maxPos || 3;
            
            // Update EMA series using BAR TIME (snapped to minute)
            if (emaSellSeries) emaSellSeries.update({ time: barTime, value: fixedEmaValue });
            if (emaBuySeries) emaBuySeries.update({ time: barTime, value: fixedEmaValue });
            
            // Update L1-Ln threshold series using BAR TIME
            for (let i = 0; i < maxPos && i < sellThresholdSeries.length; i++) {
                const offset = firstSpread + i * nextSpread;
                const upperVal = fixedEmaValue + offset;
                const lowerVal = fixedEmaValue - offset;
                
                if (sellThresholdSeries[i]) sellThresholdSeries[i].update({ time: barTime, value: upperVal });
                if (buyThresholdSeries[i]) buyThresholdSeries[i].update({ time: barTime, value: lowerVal });
            }
        }
        
        // Set threshold series historical data
        function setThresholdSeriesData(emaData) {
            if (!emaData || emaData.length === 0) return;
            
            // Sync freeze variables with last history point
            const last = emaData[emaData.length - 1];
            if (last) {
                lastEmaUpdateTime = last.time;
                fixedEmaValue = last.value;
            }
            
            const firstSpread = currentParams.firstSpread || 3.0;
            const nextSpread = currentParams.nextSpread || 1.0;
            const maxPos = currentParams.maxPos || 3;
            
            // Set EMA data
            emaSellSeries.setData(emaData);
            emaBuySeries.setData(emaData);
            
            // Calculate and set L1-Ln data
            for (let i = 0; i < 5; i++) {
                if (i < maxPos) {
                    const offset = firstSpread + i * nextSpread;
                    
                    // Sell chart: upper threshold
                    const sellData = emaData.map(d => ({
                        time: d.time,
                        value: d.value + offset
                    }));
                    sellThresholdSeries[i].setData(sellData);
                    
                    // Buy chart: lower threshold
                    const buyData = emaData.map(d => ({
                        time: d.time,
                        value: d.value - offset
                    }));
                    buyThresholdSeries[i].setData(buyData);
                } else {
                    // Clear unused levels
                    sellThresholdSeries[i].setData([]);
                    buyThresholdSeries[i].setData([]);
                }
            }
        }
        
        function handleTradeResult(result) {
            if (!result) return;
            
            const status = result.status || '';
            const error = result.error || '';
            const direction = result.direction || '';
            const vol = result.vol || 0;
            
            if (status === 'filled_all') {
                addLog(`‰∫§ÊòìÊàêÂäü: ${direction.toUpperCase()} ${vol} Êâã`, 'success');
                // ÂèØÈÄâÔºöÊàêÂäüÊèêÁ§∫
            } else if (status.includes('skipped')) {
                let msg = '‰∫§ÊòìÂ∑≤Ë∑≥Ëøá: ';
                if (status === 'skipped_market_closed') msg += 'Â∏ÇÂú∫Â∑≤ÂÖ≥Èó≠';
                else if (status === 'skipped_already_filled') msg += '‰ªì‰ΩçÂ∑≤Âà∞ËææÁõÆÊ†á';
                else if (status === 'skipped_small_volume') msg += '‰∫§ÊòìÈáèËøáÂ∞è';
                else msg += status;
                
                alert(msg);
                addLog(msg, 'warn');
            } else if (status.includes('failed')) {
                let msg = '‰∫§ÊòìÂ§±Ë¥•!\n';
                msg += `Áä∂ÊÄÅ: ${status}\n`;
                if (error) msg += `ÈîôËØØ: ${error}`;
                
                alert(msg);
                addLog(`‰∫§ÊòìÂ§±Ë¥•: ${status} - ${error}`, 'error');
            }
        }
        
        function updateRealtimeQuotes(tick) {
            // Debug: Check consistency
            // console.log("Tick:", tick); 
            
            // Verify symbol if provided
            if (tick.mt5_symbol) {
               // Update Labels dynamically
               const mt5Label = document.querySelector('.quote-card strong[style*="#4caf50"]');
               if (mt5Label && !mt5Label.textContent.includes(tick.mt5_symbol)) {
                   mt5Label.textContent = `MT5 (${tick.mt5_symbol})`;
               }
            }
            if (tick.okx_symbol) {
                const okxLabel = document.querySelector('.quote-card strong[style*="#ff9800"]');
                if (okxLabel && !okxLabel.textContent.includes(tick.okx_symbol)) {
                    okxLabel.textContent = `OKX (${tick.okx_symbol})`;
                }
            }

            if (tick.mt5_bid !== null) {
                document.getElementById('rt-mt5-bid').textContent = tick.mt5_bid.toFixed(2);
            }
            if (tick.mt5_ask !== null) {
                document.getElementById('rt-mt5-ask').textContent = tick.mt5_ask.toFixed(2);
            }
            if (tick.okx_bid !== null) {
                document.getElementById('rt-okx-bid').textContent = tick.okx_bid.toFixed(2);
            }
            if (tick.okx_ask !== null) {
                document.getElementById('rt-okx-ask').textContent = tick.okx_ask.toFixed(2);
            }
            
            const ema = tick.ema;
            
            if (tick.spread_sell !== null) {
                const el = document.getElementById('rt-spread-sell');
                el.textContent = tick.spread_sell.toFixed(2);
                el.style.color = tick.spread_sell > ema ? '#ef5350' : '#4caf50';
            }
            
            // Display 5s rolling average spread
            if (tick.avg_spread_sell !== undefined && tick.avg_spread_sell !== null) {
                const el = document.getElementById('rt-avg-spread-sell');
                el.textContent = 'Âùá:' + tick.avg_spread_sell.toFixed(2);
                el.style.color = tick.avg_spread_sell > ema ? '#ef5350' : '#4caf50';
            }
            
            if (tick.spread_buy !== null) {
                const el = document.getElementById('rt-spread-buy');
                el.textContent = tick.spread_buy.toFixed(2);
                el.style.color = tick.spread_buy < ema ? '#ef5350' : '#4caf50';
            }
            
            // Display 5s rolling average spread buy
            if (tick.avg_spread_buy !== undefined && tick.avg_spread_buy !== null) {
                const el = document.getElementById('rt-avg-spread-buy');
                el.textContent = 'Âùá:' + tick.avg_spread_buy.toFixed(2);
                el.style.color = tick.avg_spread_buy < ema ? '#ef5350' : '#4caf50';
            }

            if (tick.ema !== null) {
                document.getElementById('rt-ema').textContent = tick.ema.toFixed(2);
            }
        }

        // Order handling
        function setupTradeButtons() {
            const longHandler = () => {
                const vol = document.getElementById('tradeVol').value;
                ws.send(JSON.stringify({ type: 'params', payload: { tradeVolume: parseFloat(vol) } }));
                setTimeout(() => ws.send(JSON.stringify({ type: 'make_long' })), 100);
                addLog(`ÊâãÂä®ÂÅöÂ§ö, ÊâãÊï∞=${vol}`, 'info');
            };
            
            const shortHandler = () => {
                const vol = document.getElementById('tradeVol').value;
                ws.send(JSON.stringify({ type: 'params', payload: { tradeVolume: parseFloat(vol) } }));
                setTimeout(() => ws.send(JSON.stringify({ type: 'make_short' })), 100);
                addLog(`ÊâãÂä®ÂÅöÁ©∫, ÊâãÊï∞=${vol}`, 'info');
            };
            
            const closeAllHandler = () => {
                if (confirm("Á°ÆÂÆöË¶ÅÂÖ®ÈÉ®Âπ≥‰ªìÂêóÔºü")) {
                    ws.send(JSON.stringify({ type: 'close_all' }));
                    addLog('ÂÖ®ÈÉ®Âπ≥‰ªìÂ∑≤Ëß¶Âèë', 'warn');
                }
            };
            
            document.getElementById('btnLong')?.addEventListener('click', longHandler);
            document.getElementById('btnShort')?.addEventListener('click', shortHandler);
            document.getElementById('btnLongQuick')?.addEventListener('click', longHandler);
            document.getElementById('btnShortQuick')?.addEventListener('click', shortHandler);
            document.getElementById('closeAllBtn')?.addEventListener('click', closeAllHandler);
            document.getElementById('closeAllQuick')?.addEventListener('click', closeAllHandler);
        }
        
        setupTradeButtons();

        // Auto Trade Toggle - update both toggle and status display
        function updateAutoTradeUI(isEnabled) {
            const chkAuto = document.getElementById('chkAutoTrade');
            const statusEl = document.getElementById('autoTradeStatus');
            
            if (chkAuto) {
                chkAuto.checked = isEnabled;
            }
            
            if (statusEl) {
                if (isEnabled) {
                    statusEl.className = 'auto-trade-status on';
                    statusEl.innerHTML = '<span class="status-dot"></span><span class="status-text">Ëá™Âä®‰∫§Êòì: ËøêË°å‰∏≠</span>';
                } else {
                    statusEl.className = 'auto-trade-status off';
                    statusEl.innerHTML = '<span class="status-dot"></span><span class="status-text">Ëá™Âä®‰∫§Êòì: Â∑≤ÂÖ≥Èó≠</span>';
                }
            }
        }
        
        document.getElementById('chkAutoTrade')?.addEventListener('change', (e) => {
            const auto = e.target.checked;
            ws.send(JSON.stringify({ type: 'params', payload: { autoTrade: auto } }));
            updateAutoTradeUI(auto);
            addLog(`Ëá™Âä®‰∫§Êòì ${auto ? 'Â∑≤ÂêØÁî®' : 'Â∑≤Á¶ÅÁî®'}`, auto ? 'success' : 'warn');
        });

        function updateOrderList(orders) {
            const list = document.getElementById('orderList');
            if (!list) return;
            list.innerHTML = '';
            
            const sorted = [...orders].sort((a, b) => b.id - a.id);
            
            if (sorted.length === 0) {
                list.innerHTML = '<div style="color: var(--text-secondary); padding: 20px; text-align: center;">ÊöÇÊó†ËÆ¢Âçï</div>';
                return;
            }
            
            sorted.forEach(o => {
                const item = document.createElement('div');
                item.className = 'order-item';
                
                const date = new Date(o.ts);
                const timeStr = date.toLocaleString();
                
                const dirColor = o.direction === 'long' ? 'var(--green)' : 'var(--red)';
                
                let statusColor = 'var(--text-secondary)';
                let statusIcon = '‚è≥';
                if (o.status === 'filled_all') {
                    statusColor = 'var(--green)';
                    statusIcon = '‚úì';
                } else if (o.status.includes('failed')) {
                    statusColor = 'var(--red)';
                    statusIcon = '‚úó';
                } else if (o.status.includes('skipped')) {
                    statusColor = '#d29922';
                    statusIcon = '‚äò';
                }

                item.innerHTML = `
                    <div class="order-header">
                        <span class="order-direction" style="color: ${dirColor}">
                            ${o.direction.toUpperCase()} L${o.level || 1}
                        </span>
                        <span class="order-time">${timeStr}</span>
                    </div>
                    <div class="order-details">
                        Vol: ${o.vol} | Status: <span style="color: ${statusColor}">${statusIcon} ${o.status}</span>
                    </div>
                    ${o.error ? `<div class="order-error">${o.error}</div>` : ''}
                `;
                list.appendChild(item);
            });
        }

        // Order Logs with PnL
        function renderOrderLogs(data) {
            const container = document.getElementById('orderLogsList');
            if (!container) return;
            
            const { orders: logOrders, pnl } = data;
            
            // Update PnL summary
            const mt5Pnl = pnl?.mt5 || 0;
            const okxPnl = pnl?.okx || 0;
            const totalPnl = pnl?.total || 0;
            const orderCount = logOrders?.length || 0;
            
            const pnlMt5El = document.getElementById('pnlMt5');
            const pnlOkxEl = document.getElementById('pnlOkx');
            const pnlTotalEl = document.getElementById('pnlTotal');
            const orderCountEl = document.getElementById('orderCount');
            
            if (pnlMt5El) {
                pnlMt5El.textContent = mt5Pnl.toFixed(2) + ' USD';
                pnlMt5El.className = 'pnl-value ' + (mt5Pnl > 0 ? 'pnl-positive' : (mt5Pnl < 0 ? 'pnl-negative' : 'pnl-zero'));
            }
            if (pnlOkxEl) {
                pnlOkxEl.textContent = okxPnl.toFixed(2) + ' USDT';
                pnlOkxEl.className = 'pnl-value ' + (okxPnl > 0 ? 'pnl-positive' : (okxPnl < 0 ? 'pnl-negative' : 'pnl-zero'));
            }
            if (pnlTotalEl) {
                pnlTotalEl.textContent = totalPnl.toFixed(2);
                pnlTotalEl.className = 'pnl-value total ' + (totalPnl > 0 ? 'pnl-positive' : (totalPnl < 0 ? 'pnl-negative' : 'pnl-zero'));
            }
            if (orderCountEl) {
                orderCountEl.textContent = orderCount;
            }
            
            // Render order logs list
            if (!logOrders || logOrders.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); padding: 20px; text-align: center;">ÊöÇÊó†ËÆ¢ÂçïÊó•Âøó</div>';
                return;
            }
            
            container.innerHTML = logOrders.map(o => {
                const ts = o.ts ? new Date(o.ts).toLocaleString() : '--';
                const dir = o.direction || '--';
                const level = o.level || 1;
                const vol = o.vol || '--';
                const status = o.status || '--';
                const prices = o.prices || {};
                const signal = o.signal || {};
                const ema = o.ema;
                const mt5Pnl = o.mt5_pnl || 0;
                const okxPnl = o.okx_pnl || 0;
                const itemPnl = mt5Pnl + okxPnl;
                const symbolA = o.symbol_a || '';
                const symbolB = o.symbol_b || '';
                const exchangeA = o.exchange_a || '';
                const exchangeB = o.exchange_b || '';

                const pnlClass = itemPnl > 0 ? 'pnl-positive' : (itemPnl < 0 ? 'pnl-negative' : 'pnl-zero');

                let statusHtml = '';
                if (status === 'filled_all') {
                    statusHtml = '<span style="color: var(--green);">‚úì Êàê‰∫§</span>';
                } else if (status.includes('failed')) {
                    statusHtml = `<span style="color: var(--red);">‚úó ${status}</span>`;
                } else if (status.includes('skipped')) {
                    statusHtml = `<span style="color: #d29922;">‚äò ${status}</span>`;
                } else {
                    statusHtml = `<span>${status}</span>`;
                }

                // ÁîüÊàêËß¶ÂèëÊù°‰ª∂ÊèèËø∞
                let triggerDesc = '';
                if (signal.trigger === 'manual' || signal.trigger === 'manual_reversal') {
                    const triggerLabel = signal.trigger === 'manual_reversal' ? 'üîÑ ÊâãÂä®ÂèçËΩ¨' : 'üñê ÊâãÂä®‰∫§Êòì';
                    const reasonText = signal.reason || '';
                    triggerDesc = `<div class="trigger-desc manual">${triggerLabel}${reasonText ? '<br><span style="font-size: 0.75rem; color: var(--text-secondary);">' + reasonText + '</span>' : ''}</div>`;
                } else if (signal.trigger === 'auto' || signal.trigger === 'auto_reversal') {
                    const isReversal = signal.trigger === 'auto_reversal';
                    const action = signal.action === 'short' ? 'ÂÅöÁ©∫' : 'ÂÅöÂ§ö';
                    const triggerLabel = isReversal ? `üîÑ Ëá™Âä®ÂèçËΩ¨ ‚Üí ${action}` : `‚ö° Ëá™Âä®${action}`;
                    const reasonText = signal.reason || '';

                    triggerDesc = `
                        <div class="trigger-desc auto">
                            ${triggerLabel} L${level}
                            <br><span style="font-size: 0.75rem; color: var(--text-secondary);">${reasonText}</span>
                        </div>`;
                } else if (signal.trigger) {
                    triggerDesc = `<div class="trigger-desc">${signal.trigger}</div>`;
                }

                // Êñ∞Â¢ûÔºöÊòæÁ§∫ÂìÅÁßçÂíå‰∫§ÊòìÊâÄ
                let symbolInfo = '';
                if (symbolA || symbolB || exchangeA || exchangeB) {
                    symbolInfo = `<div class="order-symbol-info" style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 2px;">
                        <span>ÂìÅÁßçA: ${symbolA} (${exchangeA})</span> &nbsp; <span>ÂìÅÁßçB: ${symbolB} (${exchangeB})</span>
                    </div>`;
                }

                return `
                    <div class="order-log-item">
                        ${symbolInfo}
                        <div class="order-log-header">
                            <div>
                                <span class="order-log-dir ${dir}">${dir.toUpperCase()} L${level}</span>
                                <span style="margin-left: 8px;">${vol} Êâã</span>
                            </div>
                            <div>
                                <span class="order-log-pnl ${pnlClass}">
                                    ${itemPnl >= 0 ? '+' : ''}${itemPnl.toFixed(2)}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; color: var(--text-secondary); font-size: 0.8rem;">
                            <span>${ts}</span>
                            <span>${statusHtml}</span>
                        </div>
                        ${triggerDesc}
                        <div class="order-log-prices">
                            <div>MT5: ${prices.mt5_bid?.toFixed(2) || '--'} / ${prices.mt5_ask?.toFixed(2) || '--'}</div>
                            <div>OKX: ${prices.okx_bid?.toFixed(2) || '--'} / ${prices.okx_ask?.toFixed(2) || '--'}</div>
                            <div>ÂÅöÁ©∫‰ª∑Â∑Æ: ${prices.spread_sell?.toFixed(2) || '--'}</div>
                            <div>ÂÅöÂ§ö‰ª∑Â∑Æ: ${prices.spread_buy?.toFixed(2) || '--'}</div>
                        </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Refresh Order Logs button
        document.getElementById('refreshOrderLogs')?.addEventListener('click', () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'get_order_logs', limit: 50 }));
                addLog('Ê≠£Âú®Ëé∑ÂèñËÆ¢ÂçïÊó•Âøó...', 'info');
            }
        });

        function loadHistory(history) {
            addLog('Ê≠£Âú®Âä†ËΩΩÂéÜÂè≤Êï∞ÊçÆ...', 'info');
            
            const OFFSET_SECONDS = 8 * 3600;

            const mt5Data = history.mt5.map(c => ({
                time: c.time + OFFSET_SECONDS,
                open: c.open,
                high: c.high,
                low: c.low,
                close: c.close
            }));
            
            const okxData = history.okx.map(c => ({
                time: c.time + OFFSET_SECONDS,
                open: c.open,
                high: c.high,
                low: c.low,
                close: c.close
            }));

            mt5Data.sort((a, b) => a.time - b.time);
            okxData.sort((a, b) => a.time - b.time);

            mt5Series.setData(mt5Data);
            okxSeries.setData(okxData);
            
            let spreadSellData = [];
            let spreadBuyData = [];
            let emaData = [];
            
            if (history.spread && history.ema) {
                emaData = history.ema.map(d => ({
                    time: d.time + OFFSET_SECONDS,
                    value: d.value
                }));
                
                if (history.spread_sell) {
                    spreadSellData = history.spread_sell.map(d => ({
                        time: d.time + OFFSET_SECONDS,
                        value: d.value
                    }));
                }
                if (history.spread_buy) {
                    spreadBuyData = history.spread_buy.map(d => ({
                        time: d.time + OFFSET_SECONDS,
                        value: d.value
                    }));
                }
            }

            // Set spread data
            if (spreadSellData.length > 0 || spreadBuyData.length > 0) {
                if (spreadSellData.length > 0) spreadSellSeries.setData(spreadSellData);
                if (spreadBuyData.length > 0) spreadBuySeries.setData(spreadBuyData);

                globalSpreadData = [...spreadSellData];
                globalEmaData = [...emaData];
                emaHistoryData = [...emaData];
                renderOrderMarkers();
                
                // Set EMA and L1-Ln threshold series historical data
                if (emaData.length > 0) {
                    setThresholdSeriesData(emaData);
                }
            }
            
            priceChart.timeScale().fitContent();
        }

        function renderOrderMarkers() {
            // ËÆ¢ÂçïÊ†áËÆ∞ÂäüËÉΩÂ∑≤Á¶ÅÁî® - LightweightCharts v4 ÁöÑ LineSeries ‰∏çÊîØÊåÅ setMarkers
            // ËÆ¢Âçï‰ø°ÊÅØÂú®"ËÆ¢Âçï"Ê†áÁ≠æÈ°µ‰∏≠Êü•Áúã
        }

        function updateParamsUI(params) {
            currentParams = { ...currentParams, ...params };
            document.getElementById('mt5Symbol').textContent = params.MT5_SYMBOL || '-';
            document.getElementById('okxSymbol').textContent = params.OKX_SYMBOL || '-';

            const editableKeys = ['emaPeriod', 'firstSpread', 'nextSpread', 'takeProfit', 'maxPos'];
            paramsForm.innerHTML = '';
            
            editableKeys.forEach(key => {
                if (params[key] !== undefined) {
                    const div = document.createElement('div');
                    div.className = 'control-group';
                    const label = document.createElement('label');
                    label.textContent = key;
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = params[key];
                    input.dataset.key = key;
                    input.step = key.includes('Spread') || key.includes('Profit') ? '0.1' : '1';
                    div.appendChild(label);
                    div.appendChild(input);
                    paramsForm.appendChild(div);
                }
            });

            document.getElementById('tradeVol').value = params.tradeVolume || 0.01;
            
            // Update auto trade UI from server params
            if (params.autoTrade !== undefined) {
                updateAutoTradeUI(params.autoTrade);
            }

            currentParams = params;
        }

        document.getElementById('updateBtn')?.addEventListener('click', () => {
            const inputs = paramsForm.querySelectorAll('input');
            const payload = {};
            inputs.forEach(input => {
                payload[input.dataset.key] = parseFloat(input.value);
            });
            const v = document.getElementById('tradeVol').value;
            if (v) payload['tradeVolume'] = parseFloat(v);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'params', payload }));
                addLog('ÂèÇÊï∞Â∑≤Êõ¥Êñ∞', 'success');
                
                setTimeout(() => {
                    ws.send(JSON.stringify({ type: 'refresh_history' }));
                }, 200);
            }
        });

        function toTime(isoStr) {
            return Math.floor(new Date(isoStr).getTime() / 1000);
        }

        function updateCharts(bar) {
            const OFFSET_SECONDS = 8 * 3600;
            const time = toTime(bar.ts) + OFFSET_SECONDS;
            
            if (bar.mt5 && bar.mt5.close > 0 && mt5Series) {
                mt5Series.update({
                    time: time,
                    open: bar.mt5.open,
                    high: bar.mt5.high,
                    low: bar.mt5.low,
                    close: bar.mt5.close
                });
            }
            
            if (bar.okx && bar.okx.close > 0 && okxSeries) {
                okxSeries.update({
                    time: time,
                    open: bar.okx.open,
                    high: bar.okx.high,
                    low: bar.okx.low,
                    close: bar.okx.close
                });
            }
            
            if (bar.mt5 && bar.mt5.close > 0) document.getElementById('mt5Val').textContent = bar.mt5.close.toFixed(2);
            if (bar.okx && bar.okx.close > 0) document.getElementById('okxVal').textContent = bar.okx.close.toFixed(2);

            if (bar.spread_sell !== undefined && spreadSellSeries) {
                spreadSellSeries.update({ time: time, value: bar.spread_sell });
            }
            
            if (bar.spread_buy !== undefined && spreadBuySeries) {
                spreadBuySeries.update({ time: time, value: bar.spread_buy });
            }
            
            // Sync EMA series with Bar Data (1m update)
            if (bar.ema !== undefined) {
                 if (emaSellSeries) emaSellSeries.update({ time: time, value: bar.ema });
                 if (emaBuySeries) emaBuySeries.update({ time: time, value: bar.ema });
                 
                 // Also Update Thresholds
                 const firstSpread = currentParams.firstSpread || 3.0;
                 const nextSpread = currentParams.nextSpread || 1.0;
                 const maxPos = currentParams.maxPos || 3;
                 
                 for (let i = 0; i < maxPos && i < sellThresholdSeries.length; i++) {
                    const offset = firstSpread + i * nextSpread;
                    if (sellThresholdSeries[i]) sellThresholdSeries[i].update({ time: time, value: bar.ema + offset });
                    if (buyThresholdSeries[i]) buyThresholdSeries[i].update({ time: time, value: bar.ema - offset });
                 }
            }
            
            if (globalSpreadData.length === 0 || globalSpreadData[globalSpreadData.length - 1].time !== time) {
                globalSpreadData.push({ time: time, value: bar.spread_sell || bar.spread });
                globalEmaData.push({ time: time, value: bar.ema });
                
                if (globalSpreadData.length > 5000) {
                    globalSpreadData = globalSpreadData.slice(-5000);
                    globalEmaData = globalEmaData.slice(-5000);
                }
                
                renderOrderMarkers();
            }
            
        }

        // Account Polling
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "get_account", payload: { task_id: currentTask } }));
            }
        }, 3000);

        // Start
        addLog('Â•óÂà©ÁõëÊéßÂ∑≤ÂêØÂä®', 'info');
        connect();
    </script>
</body>
</html>
